<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Monster</title>
  <!-- SheetJS for XLSX parsing (client-side, no backend) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
      color: #fff;
    }

    .subtitle {
      color: #888;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #282828;
    }
    .tab {
      padding: 10px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      background: transparent;
      color: #888;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover { color: #ccc; }
    .tab.active {
      color: #fff;
      border-bottom-color: #ff0000;
    }
    .tab.active-imdb {
      color: #fff;
      border-bottom-color: #f5c518;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      font-size: 0.95rem;
      font-family: monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 8px;
      resize: vertical;
      outline: none;
    }
    textarea:focus {
      border-color: #ff0000;
    }
    .imdb-panel textarea:focus {
      border-color: #f5c518;
    }
    textarea::placeholder {
      color: #555;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 0.95rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.85; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-primary {
      background: #ff0000;
      color: #fff;
    }
    .btn-primary-imdb {
      background: #f5c518;
      color: #000;
    }

    .btn-secondary {
      background: #333;
      color: #e0e0e0;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      color: #888;
      min-height: 1.2em;
    }

    .results {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .results-posters {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }

    .thumb-card {
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #282828;
    }

    .thumb-card img {
      width: 100%;
      display: block;
      aspect-ratio: 16/9;
      object-fit: cover;
      background: #222;
    }

    .thumb-card.poster-card img {
      aspect-ratio: 2/3;
      object-fit: cover;
    }

    .thumb-card .card-body {
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .thumb-card .video-id {
      font-family: monospace;
      font-size: 0.8rem;
      color: #888;
      word-break: break-all;
    }

    .thumb-card .poster-title {
      font-size: 0.85rem;
      color: #fff;
      font-weight: 600;
    }

    .thumb-card .poster-year {
      font-size: 0.75rem;
      color: #f5c518;
    }

    .thumb-card .quality-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .quality-btn {
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 4px;
      background: #282828;
      color: #ccc;
      border: 1px solid #383838;
    }
    .quality-btn:hover {
      background: #383838;
    }
    .quality-btn.active {
      background: #ff0000;
      color: #fff;
      border-color: #ff0000;
    }
    .quality-btn.active-imdb {
      background: #f5c518;
      color: #000;
      border-color: #f5c518;
    }

    .download-btn {
      padding: 6px 14px;
      font-size: 0.85rem;
      background: #282828;
      color: #fff;
      border: 1px solid #383838;
      border-radius: 4px;
      text-align: center;
    }
    .download-btn:hover {
      background: #ff0000;
      border-color: #ff0000;
    }

    .error-card {
      background: #1a1a1a;
      border: 1px solid #442222;
      border-radius: 8px;
      padding: 16px;
      color: #ff6666;
      font-size: 0.9rem;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      color: #555;
      font-size: 0.85rem;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #333;
    }

    .drop-zone {
      border: 2px dashed #333;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: #ff0000;
      background: rgba(255, 0, 0, 0.05);
    }
    .drop-zone p {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .drop-zone .drop-hint {
      color: #555;
      font-size: 0.8rem;
    }
    .drop-zone input[type="file"] {
      display: none;
    }

    .file-info {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #0f9;
    }

    /* API key section */
    .api-section {
      margin-bottom: 16px;
      padding: 14px;
      background: rgba(245, 197, 24, 0.04);
      border: 1px solid rgba(245, 197, 24, 0.15);
      border-radius: 8px;
    }
    .api-section label {
      font-size: 0.85rem;
      color: #ccc;
      display: block;
      margin-bottom: 6px;
    }
    .api-section input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 0.9rem;
      font-family: monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      border: 1px solid #333;
      border-radius: 6px;
      outline: none;
    }
    .api-section input[type="text"]:focus {
      border-color: #f5c518;
    }
    .api-section .note {
      font-size: 0.75rem;
      color: #777;
      margin-top: 6px;
      line-height: 1.4;
    }
    .api-section .note a {
      color: #f5c518;
    }

    .tab.active-news {
      color: #fff;
      border-bottom-color: #4a9eff;
    }
    .btn-primary-news {
      background: #4a9eff;
      color: #fff;
    }

    .news-card-preview {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: stretch;
      min-height: 100px;
    }
    .news-card-preview .logo-side {
      width: 80px;
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      padding: 12px;
    }
    .news-card-preview .logo-side img {
      width: 48px;
      height: 48px;
      object-fit: contain;
    }
    .news-card-preview .headline-side {
      flex: 1;
      padding: 16px 20px;
      display: flex;
      align-items: center;
    }
    .news-card-preview .headline-text {
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 1.05rem;
      font-weight: 700;
      color: #111;
      line-height: 1.35;
    }
    .news-card-preview .source-name {
      font-family: -apple-system, sans-serif;
      font-size: 0.7rem;
      color: #888;
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .news-card-wrapper {
      background: #1a1a1a;
      border: 1px solid #282828;
      border-radius: 8px;
      overflow: hidden;
    }
    .news-card-wrapper .card-body {
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .news-card-wrapper canvas {
      display: none;
    }

    @media (max-width: 600px) {
      .container { padding: 1.5rem 0.75rem; }
      h1 { font-size: 1.4rem; }
      .results { grid-template-columns: 1fr; }
      .results-posters { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .drop-zone { padding: 16px; }
      .tab { padding: 8px 16px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Media Monster</h1>
    <p class="subtitle">Download YouTube thumbnails, movie/TV posters, or generate news headline cards.</p>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('youtube')">YouTube Thumbnails</button>
      <button class="tab" onclick="switchTab('imdb')">IMDb Posters</button>
      <button class="tab" onclick="switchTab('news')">News Cards</button>
    </div>

    <!-- ============ YOUTUBE TAB ============ -->
    <div class="tab-panel active" id="panel-youtube">
      <textarea id="urls" placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ
https://youtu.be/jNQXAC9IVRw
https://www.youtube.com/shorts/abc123
or just paste video IDs like dQw4w9WgXcQ"></textarea>

      <div class="divider">or upload a file</div>

      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
        <p>Drop a CSV or XLSX file here, or click to browse</p>
        <p class="drop-hint">The file should contain YouTube URLs or video IDs in any column</p>
        <input type="file" id="file-input" accept=".csv,.xlsx,.xls,.tsv,.txt">
      </div>
      <p class="file-info" id="file-info"></p>

      <div class="btn-row">
        <button class="btn-primary" onclick="fetchThumbnails()">Get Thumbnails</button>
        <button class="btn-secondary" id="yt-download-all-btn" onclick="ytDownloadAll()" disabled>Download All</button>
        <button class="btn-secondary" onclick="ytClear()">Clear</button>
      </div>

      <p class="status" id="yt-status"></p>
      <div class="results" id="yt-results"></div>
    </div>

    <!-- ============ IMDB TAB ============ -->
    <div class="tab-panel" id="panel-imdb">
      <div class="api-section">
        <label for="tmdb-key">TMDB API Key (free)</label>
        <input type="text" id="tmdb-key" placeholder="Enter your TMDB API key (v3 auth)">
        <p class="note">
          Get a free API key at <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener">themoviedb.org/settings/api</a> (takes 2 minutes).
          Your key is stored only in this browser session and never saved to disk.
        </p>
      </div>

      <textarea id="imdb-urls" placeholder="https://www.imdb.com/title/tt0111161/
https://www.imdb.com/title/tt0468569/
tt1375666
or paste multiple IMDb URLs, one per line"></textarea>

      <div class="divider">or upload a file</div>

      <div class="drop-zone" id="imdb-drop-zone" onclick="document.getElementById('imdb-file-input').click()">
        <p>Drop a CSV or XLSX file here, or click to browse</p>
        <p class="drop-hint">The file should contain IMDb URLs or title IDs (tt1234567) in any column</p>
        <input type="file" id="imdb-file-input" accept=".csv,.xlsx,.xls,.tsv,.txt">
      </div>
      <p class="file-info" id="imdb-file-info"></p>

      <div class="btn-row">
        <button class="btn-primary-imdb" onclick="fetchPosters()">Get Posters</button>
        <button class="btn-secondary" id="imdb-download-all-btn" onclick="imdbDownloadAll()" disabled>Download All</button>
        <button class="btn-secondary" onclick="imdbClear()">Clear</button>
      </div>

      <p class="status" id="imdb-status"></p>
      <div class="results results-posters" id="imdb-results"></div>
    </div>

    <!-- ============ NEWS CARDS TAB ============ -->
    <div class="tab-panel" id="panel-news">
      <textarea id="news-urls" placeholder="https://www.foxnews.com/politics/some-article
https://www.bbc.com/news/some-article
https://www.nytimes.com/2024/01/01/some-article
Paste one news article URL per line"></textarea>

      <div class="btn-row">
        <button class="btn-primary-news" onclick="fetchNewsCards()">Generate Cards</button>
        <button class="btn-secondary" id="news-download-all-btn" onclick="newsDownloadAll()" disabled>Download All</button>
        <button class="btn-secondary" onclick="newsClear()">Clear</button>
      </div>

      <p class="status" id="news-status"></p>
      <div class="results" id="news-results"></div>
    </div>
  </div>

  <script>
    // ============================================================
    // TAB SWITCHING
    // ============================================================
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active', 'active-imdb', 'active-news'); });
      document.querySelectorAll('.tab-panel').forEach(function (p) { p.classList.remove('active'); });
      if (tab === 'youtube') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('panel-youtube').classList.add('active');
      } else if (tab === 'imdb') {
        document.querySelectorAll('.tab')[1].classList.add('active-imdb');
        document.getElementById('panel-imdb').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[2].classList.add('active-news');
        document.getElementById('panel-news').classList.add('active');
      }
    }

    // ============================================================
    // YOUTUBE THUMBNAILS
    // ============================================================
    var ytQualities = [
      { key: "maxresdefault", label: "Max (1280x720)" },
      { key: "sddefault",     label: "SD (640x480)" },
      { key: "hqdefault",     label: "HQ (480x360)" },
      { key: "mqdefault",     label: "MQ (320x180)" },
      { key: "default",       label: "Default (120x90)" }
    ];

    var ytStates = {};

    function extractVideoId(url) {
      url = url.trim();
      if (!url) return null;
      var patterns = [
        /(?:youtube\.com\/watch\?.*v=)([a-zA-Z0-9_-]{11})/,
        /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
        /(?:youtube\.com\/live\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/
      ];
      for (var i = 0; i < patterns.length; i++) {
        var match = url.match(patterns[i]);
        if (match) return match[1];
      }
      return null;
    }

    function ytThumbUrl(videoId, quality) {
      return "https://img.youtube.com/vi/" + videoId + "/" + quality + ".jpg";
    }

    function fetchThumbnails() {
      var input = document.getElementById("urls").value;
      var lines = input.split(/[\n,]+/).map(function (s) { return s.trim(); }).filter(Boolean);
      var results = document.getElementById("yt-results");
      var status = document.getElementById("yt-status");
      results.innerHTML = "";
      ytStates = {};

      if (lines.length === 0) {
        status.textContent = "Please enter at least one YouTube URL.";
        return;
      }

      var ids = [], errors = [];
      lines.forEach(function (line) {
        var id = extractVideoId(line);
        if (id) { if (ids.indexOf(id) === -1) ids.push(id); }
        else { errors.push(line); }
      });

      errors.forEach(function (e) {
        var div = document.createElement("div");
        div.className = "error-card";
        div.textContent = "Could not parse: " + e;
        results.appendChild(div);
      });

      if (ids.length === 0) {
        status.textContent = "No valid YouTube URLs found.";
        document.getElementById("yt-download-all-btn").disabled = true;
        return;
      }

      status.textContent = "Loading " + ids.length + " thumbnail" + (ids.length > 1 ? "s" : "") + "...";
      var loaded = 0;
      ids.forEach(function (id) {
        ytStates[id] = { quality: "maxresdefault" };
        createYtCard(id, results, function () {
          loaded++;
          if (loaded === ids.length) {
            status.textContent = ids.length + " thumbnail" + (ids.length > 1 ? "s" : "") + " loaded.";
            document.getElementById("yt-download-all-btn").disabled = false;
          }
        });
      });
    }

    function createYtCard(videoId, container, onLoad) {
      var card = document.createElement("div");
      card.className = "thumb-card";

      var img = document.createElement("img");
      img.alt = "Thumbnail for " + videoId;
      img.crossOrigin = "anonymous";
      img.src = ytThumbUrl(videoId, "maxresdefault");
      img.onerror = function () {
        img.src = ytThumbUrl(videoId, "hqdefault");
        ytStates[videoId].quality = "hqdefault";
        card.querySelectorAll(".quality-btn").forEach(function (b) {
          b.classList.remove("active");
          if (b.dataset.quality === "hqdefault") b.classList.add("active");
        });
      };
      img.onload = function () { if (onLoad) onLoad(); };

      var body = document.createElement("div");
      body.className = "card-body";

      var idLabel = document.createElement("div");
      idLabel.className = "video-id";
      idLabel.textContent = videoId;

      var qualityRow = document.createElement("div");
      qualityRow.className = "quality-row";
      ytQualities.forEach(function (q) {
        var btn = document.createElement("button");
        btn.className = "quality-btn" + (q.key === "maxresdefault" ? " active" : "");
        btn.textContent = q.label;
        btn.dataset.quality = q.key;
        btn.onclick = function () {
          ytStates[videoId].quality = q.key;
          img.src = ytThumbUrl(videoId, q.key);
          qualityRow.querySelectorAll(".quality-btn").forEach(function (b) {
            b.classList.remove("active");
            if (b.dataset.quality === q.key) b.classList.add("active");
          });
        };
        qualityRow.appendChild(btn);
      });

      var dlBtn = document.createElement("button");
      dlBtn.className = "download-btn";
      dlBtn.textContent = "Download";
      dlBtn.onclick = function () { downloadImage(ytThumbUrl(videoId, ytStates[videoId].quality), videoId + "_" + ytStates[videoId].quality + ".jpg"); };

      body.appendChild(idLabel);
      body.appendChild(qualityRow);
      body.appendChild(dlBtn);
      card.appendChild(img);
      card.appendChild(body);
      container.appendChild(card);
    }

    function downloadImage(url, filename) {
      var img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function () {
        var canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        try {
          var dataUrl = canvas.toDataURL("image/jpeg", 0.95);
          var a = document.createElement("a");
          a.href = dataUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (e) {
          window.open(url, "_blank");
        }
      };
      img.onerror = function () { window.open(url, "_blank"); };
      img.src = url;
    }

    function ytDownloadAll() {
      var ids = Object.keys(ytStates);
      if (ids.length === 0) return;
      var status = document.getElementById("yt-status");
      status.textContent = "Downloading " + ids.length + " thumbnail" + (ids.length > 1 ? "s" : "") + "...";
      var delay = 0;
      ids.forEach(function (id) {
        setTimeout(function () {
          downloadImage(ytThumbUrl(id, ytStates[id].quality), id + "_" + ytStates[id].quality + ".jpg");
        }, delay);
        delay += 400;
      });
      setTimeout(function () {
        status.textContent = "Downloads started.";
      }, delay);
    }

    function ytClear() {
      document.getElementById("urls").value = "";
      document.getElementById("yt-results").innerHTML = "";
      document.getElementById("yt-status").textContent = "";
      document.getElementById("yt-download-all-btn").disabled = true;
      document.getElementById("file-info").textContent = "";
      ytStates = {};
    }

    // ============================================================
    // IMDB POSTERS (via TMDB API)
    // ============================================================
    var posterSizes = [
      { key: "original",  label: "Original" },
      { key: "w780",      label: "Large (780px)" },
      { key: "w500",      label: "Medium (500px)" },
      { key: "w342",      label: "Small (342px)" },
      { key: "w185",      label: "Thumb (185px)" }
    ];

    var imdbStates = {};

    function extractImdbId(url) {
      url = url.trim();
      if (!url) return null;
      var match = url.match(/(tt\d{7,})/);
      return match ? match[1] : null;
    }

    function getTmdbKey() {
      return document.getElementById("tmdb-key").value.trim();
    }

    function posterUrl(posterPath, size) {
      return "https://image.tmdb.org/t/p/" + size + posterPath;
    }

    async function fetchPosters() {
      var apiKey = getTmdbKey();
      if (!apiKey) {
        document.getElementById("imdb-status").textContent = "Please enter your TMDB API key above.";
        return;
      }

      var input = document.getElementById("imdb-urls").value;
      var lines = input.split(/[\n,]+/).map(function (s) { return s.trim(); }).filter(Boolean);
      var results = document.getElementById("imdb-results");
      var status = document.getElementById("imdb-status");
      results.innerHTML = "";
      imdbStates = {};

      if (lines.length === 0) {
        status.textContent = "Please enter at least one IMDb URL or title ID.";
        return;
      }

      var ids = [], errors = [];
      lines.forEach(function (line) {
        var id = extractImdbId(line);
        if (id) { if (ids.indexOf(id) === -1) ids.push(id); }
        else { errors.push(line); }
      });

      errors.forEach(function (e) {
        var div = document.createElement("div");
        div.className = "error-card";
        div.textContent = "Could not parse IMDb ID from: " + e;
        results.appendChild(div);
      });

      if (ids.length === 0) {
        status.textContent = "No valid IMDb IDs found.";
        document.getElementById("imdb-download-all-btn").disabled = true;
        return;
      }

      status.textContent = "Fetching " + ids.length + " poster" + (ids.length > 1 ? "s" : "") + " from TMDB...";

      var loaded = 0, failed = 0;
      for (var i = 0; i < ids.length; i++) {
        var imdbId = ids[i];
        try {
          var resp = await fetch("https://api.themoviedb.org/3/find/" + imdbId + "?api_key=" + apiKey + "&external_source=imdb_id");
          if (!resp.ok) throw new Error("API error " + resp.status);
          var data = await resp.json();

          var item = null;
          if (data.movie_results && data.movie_results.length > 0) {
            item = data.movie_results[0];
            item._type = "Movie";
          } else if (data.tv_results && data.tv_results.length > 0) {
            item = data.tv_results[0];
            item._type = "TV";
          }

          if (item && item.poster_path) {
            imdbStates[imdbId] = { posterPath: item.poster_path, size: "original", title: item.title || item.name, year: (item.release_date || item.first_air_date || "").substring(0, 4), type: item._type };
            createPosterCard(imdbId, results);
            loaded++;
          } else {
            var div = document.createElement("div");
            div.className = "error-card";
            div.textContent = "No poster found for " + imdbId;
            results.appendChild(div);
            failed++;
          }
        } catch (err) {
          var div = document.createElement("div");
          div.className = "error-card";
          div.textContent = "Error fetching " + imdbId + ": " + err.message;
          results.appendChild(div);
          failed++;
        }
      }

      if (loaded > 0) {
        status.textContent = loaded + " poster" + (loaded > 1 ? "s" : "") + " loaded." + (failed > 0 ? " " + failed + " failed." : "");
        document.getElementById("imdb-download-all-btn").disabled = false;
      } else {
        status.textContent = "No posters found." + (failed > 0 ? " " + failed + " failed." : "");
      }
    }

    function createPosterCard(imdbId, container) {
      var state = imdbStates[imdbId];
      var card = document.createElement("div");
      card.className = "thumb-card poster-card";

      var img = document.createElement("img");
      img.alt = "Poster for " + state.title;
      img.crossOrigin = "anonymous";
      img.src = posterUrl(state.posterPath, "original");

      var body = document.createElement("div");
      body.className = "card-body";

      var titleEl = document.createElement("div");
      titleEl.className = "poster-title";
      titleEl.textContent = state.title;

      var yearEl = document.createElement("div");
      yearEl.className = "poster-year";
      yearEl.textContent = (state.year ? state.year + " · " : "") + state.type + " · " + imdbId;

      var qualityRow = document.createElement("div");
      qualityRow.className = "quality-row";
      posterSizes.forEach(function (s) {
        var btn = document.createElement("button");
        btn.className = "quality-btn" + (s.key === "original" ? " active-imdb" : "");
        btn.textContent = s.label;
        btn.dataset.size = s.key;
        btn.onclick = function () {
          state.size = s.key;
          img.src = posterUrl(state.posterPath, s.key);
          qualityRow.querySelectorAll(".quality-btn").forEach(function (b) {
            b.classList.remove("active-imdb");
            if (b.dataset.size === s.key) b.classList.add("active-imdb");
          });
        };
        qualityRow.appendChild(btn);
      });

      var dlBtn = document.createElement("button");
      dlBtn.className = "download-btn";
      dlBtn.textContent = "Download";
      dlBtn.onclick = function () {
        var fname = state.title.replace(/[^a-zA-Z0-9]/g, "_") + "_poster.jpg";
        downloadImage(posterUrl(state.posterPath, state.size), fname);
      };

      body.appendChild(titleEl);
      body.appendChild(yearEl);
      body.appendChild(qualityRow);
      body.appendChild(dlBtn);
      card.appendChild(img);
      card.appendChild(body);
      container.appendChild(card);
    }

    function imdbDownloadAll() {
      var ids = Object.keys(imdbStates);
      if (ids.length === 0) return;
      var status = document.getElementById("imdb-status");
      status.textContent = "Downloading " + ids.length + " poster" + (ids.length > 1 ? "s" : "") + "...";
      var delay = 0;
      ids.forEach(function (id) {
        setTimeout(function () {
          var state = imdbStates[id];
          var fname = state.title.replace(/[^a-zA-Z0-9]/g, "_") + "_poster.jpg";
          downloadImage(posterUrl(state.posterPath, state.size), fname);
        }, delay);
        delay += 400;
      });
      setTimeout(function () { status.textContent = "Downloads started."; }, delay);
    }

    function imdbClear() {
      document.getElementById("imdb-urls").value = "";
      document.getElementById("imdb-results").innerHTML = "";
      document.getElementById("imdb-status").textContent = "";
      document.getElementById("imdb-download-all-btn").disabled = true;
      document.getElementById("imdb-file-info").textContent = "";
      imdbStates = {};
    }

    // ============================================================
    // NEWS CARDS
    // ============================================================
    var newsStates = {};
    var newsCounter = 0;

    function extractDomain(url) {
      try {
        var hostname = new URL(url).hostname;
        return hostname.replace(/^www\./, "");
      } catch (e) {
        return null;
      }
    }

    function prettySourceName(domain) {
      var names = {
        "foxnews.com": "Fox News",
        "bbc.com": "BBC News",
        "bbc.co.uk": "BBC News",
        "nytimes.com": "The New York Times",
        "washingtonpost.com": "The Washington Post",
        "cnn.com": "CNN",
        "reuters.com": "Reuters",
        "apnews.com": "AP News",
        "theguardian.com": "The Guardian",
        "aljazeera.com": "Al Jazeera",
        "nbcnews.com": "NBC News",
        "abcnews.go.com": "ABC News",
        "cbsnews.com": "CBS News",
        "usatoday.com": "USA Today",
        "wsj.com": "The Wall Street Journal",
        "politico.com": "Politico",
        "bloomberg.com": "Bloomberg",
        "forbes.com": "Forbes",
        "time.com": "TIME",
        "npr.org": "NPR",
        "vice.com": "VICE",
        "thehill.com": "The Hill",
        "axios.com": "Axios",
        "vox.com": "Vox",
        "buzzfeednews.com": "BuzzFeed News",
        "dailymail.co.uk": "Daily Mail",
        "independent.co.uk": "The Independent",
        "telegraph.co.uk": "The Telegraph",
        "sky.com": "Sky News",
        "news.sky.com": "Sky News"
      };
      return names[domain] || domain.charAt(0).toUpperCase() + domain.slice(1).replace(/\.\w+$/, "");
    }

    function logoUrl(domain) {
      // Clearbit gives high-quality company logos
      return "https://logo.clearbit.com/" + domain;
    }
    function logoUrlFallback(domain) {
      return "https://icons.duckduckgo.com/ip3/" + domain + ".ico";
    }
    function logoUrlFallback2(domain) {
      return "https://www.google.com/s2/favicons?domain=" + domain + "&sz=128";
    }

    // Try multiple CORS proxies in order
    var corsProxies = [
      function (u) { return "https://api.allorigins.win/raw?url=" + encodeURIComponent(u); },
      function (u) { return "https://corsproxy.io/?" + encodeURIComponent(u); },
      function (u) { return "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(u); }
    ];

    async function fetchHeadline(url) {
      var lastErr = null;
      for (var p = 0; p < corsProxies.length; p++) {
        try {
          var proxyUrl = corsProxies[p](url);
          var resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          var html = await resp.text();

          // Try og:title first
          var ogMatch = html.match(/<meta[^>]+property=["']og:title["'][^>]+content=["']([^"']+)["']/i)
                     || html.match(/<meta[^>]+content=["']([^"']+)["'][^>]+property=["']og:title["']/i);
          if (ogMatch) return decodeHtmlEntities(ogMatch[1]);

          // Fallback to <title>
          var titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
          if (titleMatch) return decodeHtmlEntities(titleMatch[1]);

          throw new Error("No headline found in HTML");
        } catch (err) {
          lastErr = err;
        }
      }
      throw lastErr || new Error("All proxies failed");
    }

    function decodeHtmlEntities(str) {
      var textarea = document.createElement("textarea");
      textarea.innerHTML = str;
      return textarea.value;
    }

    async function fetchNewsCards() {
      var input = document.getElementById("news-urls").value;
      var lines = input.split(/[\n,]+/).map(function (s) { return s.trim(); }).filter(Boolean);
      var results = document.getElementById("news-results");
      var status = document.getElementById("news-status");
      results.innerHTML = "";
      newsStates = {};
      newsCounter = 0;

      if (lines.length === 0) {
        status.textContent = "Please enter at least one news article URL.";
        return;
      }

      // Filter valid URLs
      var urls = [], errors = [];
      lines.forEach(function (line) {
        if (line.match(/^https?:\/\//i)) {
          urls.push(line);
        } else {
          errors.push(line);
        }
      });

      errors.forEach(function (e) {
        var div = document.createElement("div");
        div.className = "error-card";
        div.textContent = "Not a valid URL: " + e;
        results.appendChild(div);
      });

      if (urls.length === 0) {
        status.textContent = "No valid URLs found.";
        return;
      }

      status.textContent = "Fetching " + urls.length + " headline" + (urls.length > 1 ? "s" : "") + "...";

      var loaded = 0, failed = 0;
      for (var i = 0; i < urls.length; i++) {
        var url = urls[i];
        var domain = extractDomain(url);
        var cardId = "news-" + (newsCounter++);

        try {
          var headline = await fetchHeadline(url);
          newsStates[cardId] = { headline: headline, domain: domain, url: url };
          createNewsCard(cardId, results);
          loaded++;
        } catch (err) {
          // Show card with manual edit option
          newsStates[cardId] = { headline: "(Could not fetch headline — click to edit)", domain: domain, url: url };
          createNewsCard(cardId, results);
          failed++;
        }
      }

      status.textContent = loaded + " card" + (loaded !== 1 ? "s" : "") + " generated." + (failed > 0 ? " " + failed + " headline" + (failed > 1 ? "s" : "") + " could not be fetched (click to edit)." : "");
      document.getElementById("news-download-all-btn").disabled = Object.keys(newsStates).length === 0;
    }

    function createNewsCard(cardId, container) {
      var state = newsStates[cardId];
      var wrapper = document.createElement("div");
      wrapper.className = "news-card-wrapper";
      wrapper.id = cardId;

      // Preview div
      var preview = document.createElement("div");
      preview.className = "news-card-preview";

      var logoSide = document.createElement("div");
      logoSide.className = "logo-side";
      var logoImg = document.createElement("img");
      logoImg.alt = state.domain + " logo";
      logoImg.onerror = function () {
        if (logoImg.src.indexOf("clearbit") !== -1) {
          logoImg.src = logoUrlFallback(state.domain);
        } else if (logoImg.src.indexOf("duckduckgo") !== -1) {
          logoImg.src = logoUrlFallback2(state.domain);
        }
        // If all fail, browser shows broken image — acceptable
      };
      logoImg.src = logoUrl(state.domain);
      logoSide.appendChild(logoImg);

      var headlineSide = document.createElement("div");
      headlineSide.className = "headline-side";
      var headlineWrap = document.createElement("div");
      var headlineText = document.createElement("div");
      headlineText.className = "headline-text";
      headlineText.textContent = state.headline;
      headlineText.contentEditable = "true";
      headlineText.style.cursor = "text";
      headlineText.style.outline = "none";
      headlineText.addEventListener("blur", function () {
        state.headline = headlineText.textContent.trim();
      });
      var sourceName = document.createElement("div");
      sourceName.className = "source-name";
      sourceName.textContent = prettySourceName(state.domain);
      headlineWrap.appendChild(headlineText);
      headlineWrap.appendChild(sourceName);
      headlineSide.appendChild(headlineWrap);

      preview.appendChild(logoSide);
      preview.appendChild(headlineSide);

      // Card body with download button
      var body = document.createElement("div");
      body.className = "card-body";

      var urlLabel = document.createElement("div");
      urlLabel.className = "video-id";
      urlLabel.textContent = state.domain;

      var dlBtn = document.createElement("button");
      dlBtn.className = "download-btn";
      dlBtn.textContent = "Download Card";
      dlBtn.onclick = function () { downloadNewsCard(cardId); };

      body.appendChild(urlLabel);
      body.appendChild(dlBtn);
      wrapper.appendChild(preview);
      wrapper.appendChild(body);
      container.appendChild(wrapper);
    }

    function downloadNewsCard(cardId) {
      var state = newsStates[cardId];
      var canvas = document.createElement("canvas");
      var scale = 2; // Retina
      var cardW = 800;
      var cardH = 200;
      canvas.width = cardW * scale;
      canvas.height = cardH * scale;
      var ctx = canvas.getContext("2d");
      ctx.scale(scale, scale);

      // Background
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, cardW, cardH);

      // Logo side background
      ctx.fillStyle = "#f0f0f0";
      ctx.fillRect(0, 0, 80, cardH);

      // Try drawing logo via CORS proxy, with fallbacks, then text initials
      var logoSources = [
        "https://corsproxy.io/?" + encodeURIComponent(logoUrl(state.domain)),
        "https://corsproxy.io/?" + encodeURIComponent(logoUrlFallback(state.domain)),
        "https://corsproxy.io/?" + encodeURIComponent(logoUrlFallback2(state.domain))
      ];
      var logoAttempt = 0;
      var logoImg = new Image();
      logoImg.crossOrigin = "anonymous";
      logoImg.onload = function () {
        ctx.drawImage(logoImg, 16, cardH / 2 - 24, 48, 48);
        drawHeadlineText();
      };
      logoImg.onerror = function () {
        logoAttempt++;
        if (logoAttempt < logoSources.length) {
          logoImg.src = logoSources[logoAttempt];
        } else {
          // Draw text-based logo (first 2 letters of source name)
          var initials = prettySourceName(state.domain).substring(0, 2).toUpperCase();
          ctx.fillStyle = "#555";
          ctx.font = "bold 22px -apple-system, sans-serif";
          var tw = ctx.measureText(initials).width;
          ctx.fillText(initials, 40 - tw / 2, cardH / 2 + 8);
          drawHeadlineText();
        }
      };
      logoImg.src = logoSources[0];

      function drawHeadlineText() {
        // Headline text with word wrap
        ctx.fillStyle = "#111111";
        ctx.font = "bold 20px Georgia, 'Times New Roman', serif";
        var maxWidth = cardW - 80 - 40; // 80 logo side + 20px padding each side
        var x = 100;
        var lineHeight = 28;
        var words = state.headline.split(" ");
        var line = "";
        var y = 40;
        var lines = [];

        for (var i = 0; i < words.length; i++) {
          var testLine = line + (line ? " " : "") + words[i];
          var metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth && line) {
            lines.push(line);
            line = words[i];
          } else {
            line = testLine;
          }
        }
        lines.push(line);

        // Vertically center the text block
        var totalTextH = lines.length * lineHeight + 24; // +24 for source name
        y = Math.max(30, (cardH - totalTextH) / 2 + 16);

        for (var j = 0; j < lines.length; j++) {
          ctx.fillText(lines[j], x, y + j * lineHeight);
        }

        // Source name
        ctx.fillStyle = "#888888";
        ctx.font = "600 11px -apple-system, sans-serif";
        ctx.fillText(prettySourceName(state.domain).toUpperCase(), x, y + lines.length * lineHeight + 16);

        // Download
        try {
          var dataUrl = canvas.toDataURL("image/png");
          var a = document.createElement("a");
          a.href = dataUrl;
          a.download = state.domain + "_headline.png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (e) {
          alert("Could not generate image. The publication logo may be blocked by CORS.");
        }
      }
    }

    function newsDownloadAll() {
      var ids = Object.keys(newsStates);
      if (ids.length === 0) return;
      var status = document.getElementById("news-status");
      status.textContent = "Downloading " + ids.length + " card" + (ids.length > 1 ? "s" : "") + "...";
      var delay = 0;
      ids.forEach(function (id) {
        setTimeout(function () { downloadNewsCard(id); }, delay);
        delay += 600;
      });
      setTimeout(function () { status.textContent = "Downloads started."; }, delay);
    }

    function newsClear() {
      document.getElementById("news-urls").value = "";
      document.getElementById("news-results").innerHTML = "";
      document.getElementById("news-status").textContent = "";
      document.getElementById("news-download-all-btn").disabled = true;
      newsStates = {};
    }

    // ============================================================
    // FILE UPLOAD (shared logic)
    // ============================================================
    function setupDropZone(dropZoneId, fileInputId, fileInfoId, extractFn, textareaId) {
      var dz = document.getElementById(dropZoneId);
      var fi = document.getElementById(fileInputId);
      var info = document.getElementById(fileInfoId);

      dz.addEventListener("dragover", function (e) { e.preventDefault(); dz.classList.add("drag-over"); });
      dz.addEventListener("dragleave", function () { dz.classList.remove("drag-over"); });
      dz.addEventListener("drop", function (e) {
        e.preventDefault();
        dz.classList.remove("drag-over");
        if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0], extractFn, textareaId, info);
      });
      fi.addEventListener("change", function () {
        if (fi.files.length > 0) processFile(fi.files[0], extractFn, textareaId, info);
      });
    }

    function processFile(file, extractFn, textareaId, infoEl) {
      var name = file.name.toLowerCase();
      infoEl.textContent = "Reading " + file.name + "...";

      if (name.endsWith(".csv") || name.endsWith(".tsv") || name.endsWith(".txt")) {
        var reader = new FileReader();
        reader.onload = function (e) {
          var ids = extractFromText(e.target.result, extractFn);
          appendToTextarea(ids, file.name, textareaId, infoEl);
        };
        reader.onerror = function () { infoEl.textContent = "Error reading file."; };
        reader.readAsText(file);
      } else if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
        if (typeof XLSX === "undefined") { infoEl.textContent = "XLSX library not loaded."; return; }
        var reader = new FileReader();
        reader.onload = function (e) {
          try {
            var data = new Uint8Array(e.target.result);
            var wb = XLSX.read(data, { type: "array" });
            var allText = "";
            wb.SheetNames.forEach(function (s) { allText += XLSX.utils.sheet_to_csv(wb.Sheets[s]) + "\n"; });
            var ids = extractFromText(allText, extractFn);
            appendToTextarea(ids, file.name, textareaId, infoEl);
          } catch (err) { infoEl.textContent = "Error parsing file: " + err.message; }
        };
        reader.onerror = function () { infoEl.textContent = "Error reading file."; };
        reader.readAsArrayBuffer(file);
      } else {
        infoEl.textContent = "Unsupported file type.";
      }
    }

    function extractFromText(text, extractFn) {
      var tokens = text.split(/[\n\r,;\t]+/);
      var ids = [];
      tokens.forEach(function (t) {
        t = t.replace(/^["'\s]+|["'\s]+$/g, "");
        var id = extractFn(t);
        if (id && ids.indexOf(id) === -1) ids.push(id);
      });
      return ids;
    }

    function appendToTextarea(ids, filename, textareaId, infoEl) {
      if (ids.length === 0) { infoEl.textContent = "No IDs found in " + filename + "."; return; }
      infoEl.textContent = "Found " + ids.length + " ID" + (ids.length > 1 ? "s" : "") + " in " + filename + ".";
      var ta = document.getElementById(textareaId);
      var existing = ta.value.trim();
      ta.value = existing ? existing + "\n" + ids.join("\n") : ids.join("\n");
    }

    // Initialize both drop zones
    setupDropZone("drop-zone", "file-input", "file-info", extractVideoId, "urls");
    setupDropZone("imdb-drop-zone", "imdb-file-input", "imdb-file-info", extractImdbId, "imdb-urls");

    // Ctrl+Enter shortcuts
    document.getElementById("urls").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && e.ctrlKey) { e.preventDefault(); fetchThumbnails(); }
    });
    document.getElementById("imdb-urls").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && e.ctrlKey) { e.preventDefault(); fetchPosters(); }
    });
    document.getElementById("news-urls").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && e.ctrlKey) { e.preventDefault(); fetchNewsCards(); }
    });
  </script>
</body>
</html>
